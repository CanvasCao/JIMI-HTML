/*!
 * cullet Cao+Bullet, a JavaScriptPlugIn v2.0.0
 * http://www.jimi.la/
 *
 * Copyright 2016, CaoYuhao
 * All rights reserved.
 * Date: 2016-5-31 14:45:10
 */

(function(d,h,c,k){function e(a,b){this.C=this.container="string"==typeof a?c(a):a;this.json=b;this.txt=b.txt||Math.random();this.txt=18<b.txt.length?b.txt.substr(0,18)+"..":b.txt;this.lineNum=b.lineNum;this.top=b.top;this.imgUrl=b.imgUrl;this.id=(new Date).getTime().toString()+parseInt(1E4*Math.random());this.commentsPK=b.commentsPK;this.speed=b.speed;this.userType=b.userType||0;this.expression=b.expression||1;this.ccm=b.ccm;this.occupied=!0;this.liked=!1;1==this.ccm.likedObject[this.commentsPK]&&
(this.liked=!0);this.winH=c(window).height();this.winW=c(window).width();this.JM=this.jqueryMap={};this.uid=b.uid;this.config={};this.init()}function f(a,b){this.C=this.container="string"==typeof a?c(a):a;this.json=b;this.closeable=b.closeable;this.pnameable=b.pnameable;this.topBlank=b.topBlank;this.bottomBlank=b.bottomBlank;this.ccmH=c(this.C).height();this.winW=c(window).width();this.cellH=20;this.cellPaddingTop=15;this.lineNumber=Math.floor(this.ccmH/(this.cellH+this.cellPaddingTop));this.lineResArr=
    [];this.serverCommentArr=[];this.commentIndex=0;this.commentCellArr=[];this.commentLimit=10;this.likedObject={};this.ajaxedObject={};this.speedHash={slow:1,normal:2,fast:3,superfast:4};this.speedKey="normal";this.moveFPS=100;this.moveTimer=null;this.pushFPS=2;this.pushTimer=null;this.pname=this.pid="";this.init()}e.prototype={init:function(){this.initConfig();this.createDom();this.initCSS();this.bindEvent()},initConfig:function(){this.config.commentImg=0!=this.userType?'<img src="'+this.imgUrl+'" />':
'<img src="img/expression/'+this.expression+'.png" />';this.config.vipBg=0!=this.userType?'<img src="img/vip'+this.userType+'.png" />':"";0==this.userType?(this.config.normalColor="rgba(0,0,0,0.45)",this.config.likedColor="rgba(56,129,224,0.9)"):1==this.userType?this.config.normalColor=this.config.likedColor="rgba(255,0,42,0.45)":2==this.userType&&(this.config.normalColor=this.config.likedColor="rgba(238,162,0,0.55)")},createDom:function(){c(this.C).find(".commentCon").append('<div class="comment" id=cell'+
    this.id+'><div class="commentVipBg">'+this.config.vipBg+'</div><div class="commentImg">'+this.config.commentImg+'</div><div class="commentTxt">'+this.txt+'</div><div class="commentLike"><img src="img/like.png"/></div></div>');this.JM.$cell=c(this.C).find("#cell"+this.id)},initCSS:function(){this.JM.$cell.css({left:this.winW});this.JM.$cell.css({top:this.top});this.JM.$cell.css({position:"absolute",display:"block","box-sizing":"border-box","font-size":"16px",padding:"4px 22px","border-radius":"30px",
    "background-color":this.config.normalColor,opacity:1});this.JM.$cell.find(".commentVipBg").css({position:"absolute",top:-9,left:-10}).find("img").css({width:"30px"});this.JM.$cell.find(".commentImg").css({position:"absolute","border-radius":"50%",top:-2,left:-8}).find("img").css({width:"28px",height:"28px","border-radius":"50%"});this.JM.$cell.find(".commentTxt").css({color:"#fff","font-size":"12px"});this.JM.$cell.find(".commentLike").css({position:"absolute",top:-15,left:"50%",transform:"translateX(-50%)",
    "border-radius":"50%",border:"1px solid white",background:this.config.likedColor,opacity:0,width:20,height:20}).find("img").css({"margin-left":2});this.commentsPK||this.JM.$cell.css({border:"5px solid #3881e0"});this.liked&&(this.JM.$cell.css("background",this.config.likedColor),this.JM.$cell.find(".commentLike").css({top:-15,opacity:1}))},bindEvent:function(){var a=this;this.JM.$cell.click(function(){a.liked?(a.liked=!1,a.ccm.likedObject[a.commentsPK]=0,c(this).css({backgroundColor:a.config.normalColor}),
    c(this).find(".commentLike").stop().animate({opacity:0},0)):(a.liked=!0,a.ccm.likedObject[a.commentsPK]=1,c(this).css({backgroundColor:a.config.likedColor}),c(this).find(".commentLike").css({top:0}).stop().animate({top:-15,opacity:1},100));a.commentsPK&&(a.ccm.ajaxedObject.hasOwnProperty(a.commentsPK)||(a.ccm.ajaxedObject[a.commentsPK]=1,c.ajax({type:"get",url:jimiHost+"/culletSupport.php",data:{commentId:a.commentsPK},dataType:"jsonp",jsonp:"callback",jsonpCallback:"jsonpcallback",success:function(a){console.log(JSON.stringify(a))},
    error:function(a){console.log("LOAD ERROR!");console.log(a)}})),a.speed+=1)})},move:function(){var a=this.cssCell("left"),b=this.cssCell("width");this.cssCell("left",a-this.speed);this.occupied&&(a=this.cssCell("left"),b=this.cssCell("width"),a+b+20<c(window).width()&&(this.occupied=!1));this.cssCell("left")<-b&&this.die()},die:function(){var a=this;a.jqueryMap.$cell.remove();a.ccm.commentCellArr=_.without(a.ccm.commentCellArr,a);delete null},cssCell:function(a,b){if(1==arguments.length)return parseFloat(this.jqueryMap.$cell.css(a));
    this.jqueryMap.$cell.css(a,b)}};f.prototype={init:function(){d.ccm=this;this.createDom();this.initCSS();this.bindEvent()},createDom:function(){var a=this.pnameable?"<div class='commentPname'></div>":"",b=this.closeable?"<div class='commentClose'>\u00d7</div>":"";c(this.C).append("<div class='commentCon'></div>"+a+b)},initCSS:function(){c(this.C).find(".commentCon").css({position:"absolute",height:"100%",width:"100%",left:0,top:0,"box-sizing":"border-box","background-color":"rgba(0,0,0,0)",opacity:1});
    c(this.C).find(".commentPname").css({position:"absolute",height:40,width:c(window).width(),left:0,top:0,"font-size":"12px","line-height":"40px",color:"#555","padding-left":20,"border-bottom":"1px solid #ddd"});c(this.C).find(".commentClose").css({position:"absolute",top:0,left:c(window).width()-25,color:"#555","font-size":"25px","line-height":"40px"})},bindEvent:function(){var a=this;c(this.C).find(".commentClose").click(function(){a.pause();c(a.C).fadeOut()})},push:function(){if(!(this.commentCellArr.length>=
    this.serverCommentArr.length||this.commentCellArr.length>this.commentLimit)){var a;this.lineResArr=[];for(i=0+this.topBlank;i<this.lineNumber-this.bottomBlank;i++)this.lineResArr.push(i);if(this.commentCellArr.length)for(i=0;i<this.commentCellArr.length;i++)this.commentCellArr[i].occupied&&(this.lineResArr=_.without(this.lineResArr,this.commentCellArr[i].lineNum));a=this.lineResArr.length?this.lineResArr[Math.floor(Math.random()*(this.lineResArr.length-0))+0]:null;if(null!=a){var b=a*(this.cellH+
    this.cellPaddingTop)+this.cellPaddingTop,c=this.serverCommentArr[this.commentIndex];c.ccm=this;c.top=b;c.lineNum=a;c.speed=this.speedHash.normal;this.commentCellArr.push(new e(this.C,c));this.commentIndex=this.commentIndex+1>=this.serverCommentArr.length?0:this.commentIndex+1}}},move:function(){[].forEach.call(this.commentCellArr,function(a,b,c){a&&a.move()})},start:function(){var a=this;c(a.C).fadeIn();if(a.moveTimer)console.log("Timer already exists");else{var b=function(){(new Date).getTime()-
e>=1E3/a.pushFPS&&(e=(new Date).getTime(),a.push());a.pushTimer=requestAnimationFrame(b)},g=function(){(new Date).getTime()-d>=1E3/a.moveFPS&&(d=(new Date).getTime(),a.move());a.moveTimer=requestAnimationFrame(g)};window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;var d=(new Date).getTime();g();var e=(new Date).getTime();b()}},pause:function(){window.cancelAnimationFrame=window.cancelAnimationFrame||
    window.mozCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame;cancelAnimationFrame(this.moveTimer);delete this.moveTimer;cancelAnimationFrame(this.pushTimer);delete this.pushTimer},changeSpeed:function(a){var b=this;b.speedKey=b.speedHash.hasOwnProperty(a)?a:"normal";[].forEach.call(b.commentCellArr,function(a,c,d){a&&(a.speed=b.speedHash[b.speedKey])})},add:function(a){this.serverCommentArr.splice(this.commentIndex,0,a)},load:function(a){var b=
    this;a==b.pid?b.start():c.ajax({type:"get",url:jimiHost+"/culletSelect.php?pid="+a,dataType:"jsonp",jsonp:"callback",jsonpCallback:"jsonpcallback",success:function(c){console.log(JSON.stringify(c));b.pid=a;b.pname=c.pname;b.clear();b.changePname(c.pname);b.serverCommentArr=c.data;setTimeout(function(){b.start()},b.json.startDelay||0)},error:function(a){console.log("LOAD ERROR!");console.log(a)}})},clear:function(){this.commentCellArr=[];this.serverCommentArr=[];c(this.C).find(".commentCon").html("");
    this.commentIndex=0;this.pause()},changePname:function(a){c(this.C).find(".commentPname").html(a)}};d.CommentCell=e;d.CommentCellManage=f})(window,document,jQuery);